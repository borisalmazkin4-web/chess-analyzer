# ============================================
# –®–ê–•–ú–ê–¢–ù–´–ô –ê–ù–ê–õ–ò–ó–ê–¢–û–† - –®–ê–ì 2
# –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –¥–æ—Å–∫–∏ –∏ —Ä–∞–∑—Ä–µ–∑–∞–Ω–∏–µ –Ω–∞ –∫–ª–µ—Ç–∫–∏
# ============================================

import cv2
import numpy as np
import os
import shutil

print("=" * 50)
print("–®–ê–ì 2: –í–´–†–ï–ó–ê–ù–ò–ï –ö–õ–ï–¢–û–ö")
print("=" * 50)
print()

# 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –®–∞–≥–∞ 1
if not os.path.exists("chess_board.jpg"):
    print("‚ùå –§–∞–π–ª 'chess_board.jpg' –Ω–µ –Ω–∞–π–¥–µ–Ω!")
    print("   –°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –®–∞–≥ 1")
    input("–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –≤—ã—Ö–æ–¥–∞...")
    exit()

# 2. –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–æ—Ç–æ
print("üì∏ –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–æ—Ç–æ...")
image = cv2.imread('chess_board.jpg')
gray = cv2.cvtColor(image, cv2.COLOR_BGR2GRAY)
print(f"‚úÖ –†–∞–∑–º–µ—Ä —Ñ–æ—Ç–æ: {image.shape[1]} x {image.shape[0]} –ø–∏–∫—Å–µ–ª–µ–π")
print()

# 3. –ò—â–µ–º –¥–æ—Å–∫—É (–∫–∞–∫ –≤ –®–∞–≥–µ 1)
print("üîç –ò—â–µ–º —à–∞—Ö–º–∞—Ç–Ω—É—é –¥–æ—Å–∫—É...")
found, corners = cv2.findChessboardCorners(gray, (7, 7), None)

if not found:
    print("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –¥–æ—Å–∫—É! –°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –®–∞–≥ 1")
    input("–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –≤—ã—Ö–æ–¥–∞...")
    exit()

print("‚úÖ –î–æ—Å–∫–∞ –Ω–∞–π–¥–µ–Ω–∞!")
print()

# 4. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ø–∞–ø–æ–∫
print("üìÅ –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –ø–∞–ø–∫–∏...")
if os.path.exists("cells"):
    print("   –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—É—é –ø–∞–ø–∫—É 'cells'...")
    shutil.rmtree("cells")
os.makedirs("cells", exist_ok=True)
print("‚úÖ –ü–∞–ø–∫–∞ 'cells' –≥–æ—Ç–æ–≤–∞")
print()

# 5. –ü–æ–ª—É—á–∞–µ–º 4 —É–≥–ª–∞ –í–°–ï–ô –¥–æ—Å–∫–∏ (–Ω–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ 7x7, –∞ –≤–Ω–µ—à–Ω–∏–µ)
print("üìç –ù–∞—Ö–æ–¥–∏–º —É–≥–ª—ã –≤—Å–µ–π –¥–æ—Å–∫–∏...")
corners = corners.reshape(-1, 2)

# –ë–µ—Ä–µ–º 4 –∫—Ä–∞–π–Ω–∏—Ö —É–≥–ª–∞:
# top_left - –ª–µ–≤—ã–π –≤–µ—Ä—Ö–Ω–∏–π (–ø–µ—Ä–≤—ã–π —É–≥–æ–ª)
# top_right - –ø—Ä–∞–≤—ã–π –≤–µ—Ä—Ö–Ω–∏–π (7-–π —É–≥–æ–ª, —Ç.–∫. 7x7)
# bottom_right - –ø—Ä–∞–≤—ã–π –Ω–∏–∂–Ω–∏–π (–ø–æ—Å–ª–µ–¥–Ω–∏–π —É–≥–æ–ª)
# bottom_left - –ª–µ–≤—ã–π –Ω–∏–∂–Ω–∏–π (49-–π —É–≥–æ–ª, —Ç.–∫. 7x7 = 49)
top_left = corners[0]
top_right = corners[6]
bottom_right = corners[48]
bottom_left = corners[42]

print(f"   –õ–µ–≤—ã–π –≤–µ—Ä—Ö–Ω–∏–π: ({top_left[0]:.0f}, {top_left[1]:.0f})")
print(f"   –ü—Ä–∞–≤—ã–π –≤–µ—Ä—Ö–Ω–∏–π: ({top_right[0]:.0f}, {top_right[1]:.0f})")
print(f"   –ü—Ä–∞–≤—ã–π –Ω–∏–∂–Ω–∏–π: ({bottom_right[0]:.0f}, {bottom_right[1]:.0f})")
print(f"   –õ–µ–≤—ã–π –Ω–∏–∂–Ω–∏–π: ({bottom_left[0]:.0f}, {bottom_left[1]:.0f})")
print()

# 6. –í—ã—Ä–∞–≤–Ω–∏–≤–∞–µ–º –¥–æ—Å–∫—É (–¥–µ–ª–∞–µ–º –µ—ë –∫–≤–∞–¥—Ä–∞—Ç–Ω–æ–π –∏ —Ä–æ–≤–Ω–æ–π)
print("üîÑ –í—ã—Ä–∞–≤–Ω–∏–≤–∞–µ–º –¥–æ—Å–∫—É...")
size = 400  # —Ä–∞–∑–º–µ—Ä –∫–≤–∞–¥—Ä–∞—Ç–Ω–æ–π –¥–æ—Å–∫–∏ –≤ –ø–∏–∫—Å–µ–ª—è—Ö

# –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã 4 —É–≥–ª–æ–≤ –Ω–∞ –∏—Å—Ö–æ–¥–Ω–æ–º —Ñ–æ—Ç–æ
src_points = np.float32([top_left, top_right, bottom_right, bottom_left])

# –ö—É–¥–∞ –∏—Ö –ø–µ—Ä–µ–º–µ—â–∞–µ–º (–∫–≤–∞–¥—Ä–∞—Ç 400x400)
dst_points = np.float32([
    [0, 0],           # –ª–µ–≤—ã–π –≤–µ—Ä—Ö–Ω–∏–π ‚Üí (0,0)
    [size, 0],        # –ø—Ä–∞–≤—ã–π –≤–µ—Ä—Ö–Ω–∏–π ‚Üí (400,0)
    [size, size],     # –ø—Ä–∞–≤—ã–π –Ω–∏–∂–Ω–∏–π ‚Üí (400,400)
    [0, size]         # –ª–µ–≤—ã–π –Ω–∏–∂–Ω–∏–π ‚Üí (0,400)
])

# –í—ã—á–∏—Å–ª—è–µ–º –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ
matrix = cv2.getPerspectiveTransform(src_points, dst_points)

# –ü—Ä–∏–º–µ–Ω—è–µ–º –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ
warped = cv2.warpPerspective(image, matrix, (size, size))

# –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã—Ä–æ–≤–Ω–µ–Ω–Ω—É—é –¥–æ—Å–∫—É
cv2.imwrite("step2_warped_board.jpg", warped)
print(f"‚úÖ –î–æ—Å–∫–∞ –≤—ã—Ä–æ–≤–Ω–µ–Ω–∞ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞: step2_warped_board.jpg")
print(f"   –†–∞–∑–º–µ—Ä: {size} x {size} –ø–∏–∫—Å–µ–ª–µ–π")
print()

# 7. –†–∞–∑—Ä–µ–∑–∞–µ–º –Ω–∞ –∫–ª–µ—Ç–∫–∏
print("‚úÇÔ∏è –†–∞–∑—Ä–µ–∑–∞–µ–º –¥–æ—Å–∫—É –Ω–∞ 64 –∫–ª–µ—Ç–∫–∏...")
cell_size = size // 8  # —Ä–∞–∑–º–µ—Ä –æ–¥–Ω–æ–π –∫–ª–µ—Ç–∫–∏
print(f"   –†–∞–∑–º–µ—Ä –∫–ª–µ—Ç–∫–∏: {cell_size} x {cell_size} –ø–∏–∫—Å–µ–ª–µ–π")
print()

# –°–æ–∑–¥–∞—ë–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–µ—Ç–∫–∏
grid_image = warped.copy()

# –†–∏—Å—É–µ–º —Å–µ—Ç–∫—É
for i in range(9):  # 9 –ª–∏–Ω–∏–π (8 –∫–ª–µ—Ç–æ–∫ + –ø–æ—Å–ª–µ–¥–Ω—è—è –≥—Ä–∞–Ω–∏—Ü–∞)
    # –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏
    cv2.line(grid_image, (i * cell_size, 0), (i * cell_size, size), (0, 255, 0), 2)
    # –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏
    cv2.line(grid_image, (0, i * cell_size), (size, i * cell_size), (0, 255, 0), 2)

# –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å —Å–µ—Ç–∫–æ–π
cv2.imwrite("step2_board_with_grid.jpg", grid_image)
print(f"‚úÖ –°–µ—Ç–∫–∞ –Ω–∞—Ä–∏—Å–æ–≤–∞–Ω–∞: step2_board_with_grid.jpg")
print()

# 8. –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∂–¥—É—é –∫–ª–µ—Ç–∫—É –æ—Ç–¥–µ–ª—å–Ω–æ
print("üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–ª–µ—Ç–∫–∏ –≤ –ø–∞–ø–∫—É 'cells/'...")
print("   –ò–º–µ–Ω–∞ —Ñ–∞–π–ª–æ–≤: —Å—Ç—Ä–æ–∫–∞_—Å—Ç–æ–ª–±–µ—Ü.jpg")
print("   –ù–∞–ø—Ä–∏–º–µ—Ä: cell_0_0.jpg - –ª–µ–≤—ã–π –≤–µ—Ä—Ö–Ω–∏–π —É–≥–æ–ª (a8 –≤ —à–∞—Ö–º–∞—Ç–∞—Ö)")
print("             cell_7_7.jpg - –ø—Ä–∞–≤—ã–π –Ω–∏–∂–Ω–∏–π —É–≥–æ–ª (h1 –≤ —à–∞—Ö–º–∞—Ç–∞—Ö)")
print()

# –®–∞—Ö–º–∞—Ç–Ω–∞—è –Ω–æ—Ç–∞—Ü–∏—è –¥–ª—è –ø–æ–¥–ø–∏—Å–µ–π
chess_letters = ['a', 'b', 'c', 'd', 'e', 'f', 'g', 'h']
chess_numbers = ['8', '7', '6', '5', '4', '3', '2', '1']

for row in range(8):        # –æ—Ç 0 –¥–æ 7 (—Å–≤–µ—Ä—Ö—É –≤–Ω–∏–∑)
    for col in range(8):    # –æ—Ç 0 –¥–æ 7 (—Å–ª–µ–≤–∞ –Ω–∞–ø—Ä–∞–≤–æ)
        # –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫–ª–µ—Ç–∫–∏
        x1 = col * cell_size
        y1 = row * cell_size
        x2 = x1 + cell_size
        y2 = y1 + cell_size
        
        # –í—ã—Ä–µ–∑–∞–µ–º –∫–ª–µ—Ç–∫—É
        cell = warped[y1:y2, x1:x2]
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º
        filename = f"cells/cell_{row}_{col}.jpg"
        cv2.imwrite(filename, cell)
        
        # –®–∞—Ö–º–∞—Ç–Ω–æ–µ –æ–±–æ–∑–Ω–∞—á–µ–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, a8, b8, ...)
        chess_pos = f"{chess_letters[col]}{chess_numbers[row]}"
        
        # –í—ã–≤–æ–¥–∏–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–µ—Ä–≤—ã—Ö –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∫–ª–µ—Ç–∫–∞—Ö
        if row < 2 and col < 2:  # —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–µ—Ä–≤—ã—Ö 4 –∫–ª–µ—Ç–æ–∫
            print(f"   {filename} ‚Üí {chess_pos}")

print()
print("‚úÖ –í—Å–µ 64 –∫–ª–µ—Ç–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –ø–∞–ø–∫–µ 'cells/'")
print()

# 9. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
print("üëÄ –ü–æ–∫–∞–∑—ã–≤–∞—é —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:")
print("   1. –í—ã—Ä–æ–≤–Ω–µ–Ω–Ω–∞—è –¥–æ—Å–∫–∞ (–∑–∞–∫—Ä–æ–π—Ç–µ –æ–∫–Ω–æ)")
print("   2. –î–æ—Å–∫–∞ —Å —Å–µ—Ç–∫–æ–π (–∑–∞–∫—Ä–æ–π—Ç–µ –æ–∫–Ω–æ)")
print("   3. –ü—Ä–∏–º–µ—Ä—ã –∫–ª–µ—Ç–æ–∫")
print()

cv2.imshow("1. –í—ã—Ä–æ–≤–Ω–µ–Ω–Ω–∞—è –¥–æ—Å–∫–∞ (400x400)", warped)
cv2.waitKey(1000)
cv2.destroyAllWindows()

cv2.imshow("2. –î–æ—Å–∫–∞ —Å —Å–µ—Ç–∫–æ–π (8x8 –∫–ª–µ—Ç–æ–∫)", grid_image)
cv2.waitKey(1000)
cv2.destroyAllWindows()

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ 4 –∫–ª–µ—Ç–∫–∏
sample_cells = []
positions = ["a8 (–ª–µ–≤—ã–π –≤–µ—Ä—Ö–Ω–∏–π)", "h8 (–ø—Ä–∞–≤—ã–π –≤–µ—Ä—Ö–Ω–∏–π)", 
             "a1 (–ª–µ–≤—ã–π –Ω–∏–∂–Ω–∏–π)", "h1 (–ø—Ä–∞–≤—ã–π –Ω–∏–∂–Ω–∏–π)"]

# –°–æ–±–∏—Ä–∞–µ–º 4 —É–≥–ª–æ–≤—ã–µ –∫–ª–µ—Ç–∫–∏
sample_cells.append(cv2.imread("cells/cell_0_0.jpg"))      # a8
sample_cells.append(cv2.imread("cells/cell_0_7.jpg"))      # h8
sample_cells.append(cv2.imread("cells/cell_7_0.jpg"))      # a1
sample_cells.append(cv2.imread("cells/cell_7_7.jpg"))      # h1

# –°–æ–∑–¥–∞—ë–º –æ–¥–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å 4 –∫–ª–µ—Ç–∫–∞–º–∏
cell_height = cell_size
cell_width = cell_size
montage = np.zeros((cell_height * 2, cell_width * 2, 3), dtype=np.uint8)

# –†–∞–∑–º–µ—â–∞–µ–º –∫–ª–µ—Ç–∫–∏
montage[0:cell_height, 0:cell_width] = sample_cells[0]      # a8
montage[0:cell_height, cell_width:cell_width*2] = sample_cells[1]  # h8
montage[cell_height:cell_height*2, 0:cell_width] = sample_cells[2]  # a1
montage[cell_height:cell_height*2, cell_width:cell_width*2] = sample_cells[3]  # h1

# –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥–ø–∏—Å–∏
font = cv2.FONT_HERSHEY_SIMPLEX
cv2.putText(montage, "a8", (10, 30), font, 0.7, (0, 255, 255), 2)
cv2.putText(montage, "h8", (cell_width+10, 30), font, 0.7, (0, 255, 255), 2)
cv2.putText(montage, "a1", (10, cell_height+30), font, 0.7, (0, 255, 255), 2)
cv2.putText(montage, "h1", (cell_width+10, cell_height+30), font, 0.7, (0, 255, 255), 2)

cv2.imshow("3. –ü—Ä–∏–º–µ—Ä—ã 4 –∫–ª–µ—Ç–æ–∫ (a8, h8, a1, h1)", montage)
cv2.waitKey(0)
cv2.destroyAllWindows()

print()
print("‚úÖ –®–ê–ì 2 –í–´–ü–û–õ–ù–ï–ù –£–°–ü–ï–®–ù–û!")
print()
print("üìÅ –ß—Ç–æ —Å–æ–∑–¥–∞–Ω–æ:")
print("   - step2_warped_board.jpg - –≤—ã—Ä–æ–≤–Ω–µ–Ω–Ω–∞—è –¥–æ—Å–∫–∞ 400x400")
print("   - step2_board_with_grid.jpg - –¥–æ—Å–∫–∞ —Å –∑–µ–ª—ë–Ω–æ–π —Å–µ—Ç–∫–æ–π")
print("   - –ø–∞–ø–∫–∞ 'cells/' - –≤—Å–µ 64 –∫–ª–µ—Ç–∫–∏ –ø–æ –æ—Ç–¥–µ–ª—å–Ω–æ—Å—Ç–∏")
print()
print("‚ôüÔ∏è –®–∞—Ö–º–∞—Ç–Ω—ã–µ –æ–±–æ–∑–Ω–∞—á–µ–Ω–∏—è –∫–ª–µ—Ç–æ–∫:")
print("   cell_0_0.jpg = a8 (–±–µ–ª–∞—è –ª–∞–¥—å—è –≤ –Ω–∞—á–∞–ª–µ)")
print("   cell_0_1.jpg = b8 (–±–µ–ª—ã–π –∫–æ–Ω—å –≤ –Ω–∞—á–∞–ª–µ)")
print("   ... –∏ —Ç–∞–∫ –¥–∞–ª–µ–µ ...")
print("   cell_7_7.jpg = h1 (—á—ë—Ä–Ω–∞—è –ª–∞–¥—å—è –≤ –Ω–∞—á–∞–ª–µ)")
print()
print("‚û°Ô∏è  –ü–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ –∫ –®–∞–≥—É 3: —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ñ–∏–≥—É—Ä")

print("=" * 50)
input("–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è...")